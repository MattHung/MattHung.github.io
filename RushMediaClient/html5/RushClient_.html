<html>
<head>
    <script type="text/javascript" src="threadPool.js"></script>
    <script type="text/javascript" src="Setting.js"></script>
    <script type="text/javascript" src="TypeDefinition.js"></script>
    <script type="text/javascript">const THREAD_COUNT = 3;</script>

</head>
<body onload="load()">
    <script type="text/javascript" src="main.js"></script>
    <script type="text/javascript">
        //        logger.swithLogger("panel");
        logger.disableLogger();

        var Options={};

        function getParameterByName(name) {
            name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
            var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
                    results = regex.exec(location.search);
            return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
        }

        function switchResolution(w, h, b, f){
            var json_str = JSON.stringify({
                action: "switch_chanel",
                width: w,
                height: h,
                bitrate: b,
                framerate: f
            });
            wsavc.send(json_str);
        }
		
		function getConcurrentUser()
		{
			var json_str = JSON.stringify({
					action: "get_concurent_user"
				});
            wsavc.send(json_str);
		}

        function onopen(open){
            switchResolution(getParameterByName("width"), getParameterByName("height"), getParameterByName("bitrate"), getParameterByName("framerate"));
			getConcurrentUser();
        }

        function onwsmessage(json_obj){

           switch(json_obj.action){
               case "source_list":
                       for(var i=0; i<json_obj.source.length; i++) {
                           var resolution=json_obj.source[i].width.toString() + "x" + json_obj.source[i].height.toString();
                           var option = Options[resolution];
                           if(option==undefined) {
                               Options[resolution] = [];
                               option = Options[resolution];
                           }

                           Options[resolution].push(json_obj.source[i]);
                       }

                       for(var option in Options) {
                           option = Options[option];
                           for (var i = 0; i < option.length; i++) {
                               var element = document.createElement("input");
                               //Assign different attributes to the element.
                               element.type = "button";
                               element.name = "button_" + (json_obj.source.length - 1).toString();  // And the name too?

                               element.value = option[i].width.toString() +
                               "x" + option[i].height.toString() +
                               "   b:" + option[i].bitrate + " fr:" + option[i].framerate;

                               element.setAttribute("width", option[i].width);
                               element.setAttribute("height", option[i].height);
                               element.setAttribute("bitrate", option[i].bitrate);
                               element.setAttribute("framerate", option[i].framerate);

                               element.onclick = function () { // Note this is a function
                                   switchResolution(this.getAttribute("width"), this.getAttribute("height"), this.getAttribute("bitrate"), this.getAttribute("framerate"));
                               };

                               document.getElementById("Settings").appendChild(element);
                           }

                           document.getElementById("Settings").appendChild(document.createElement("br"));
                       }
                   break;
				 case "concurent_user":
					var concurent_user = json_obj.value;
					break;
           }
        }

        function onerror(error){}

        function onclose(close){}

        function load()
        {
//            wsavc.connect("ws://103.224.71.111:50480");
			wsavc.connect("ws://192.168.164.234:50480");

            wsavc.onwsopen = onopen;
            wsavc.onwsmessage = onwsmessage;
            wsavc.onwserror = onerror;
            wsavc.onwsclose = onclose;
        }

    </script>

    <div id="Settings"></div>
    <div id="Latency"></div>
</body>
</html>